# 7.1 Действия контроллера

## 7.2 Предварительный просмотр отзыва

_Задание._
Мы хотим сделать возможным добавлять новые отзывы для продуктов. Начнём с добавления предварительного просмотра.   
    1) Сделать поле для ввода текста в шаблоне product, используя помощник и создать его зачение со свойством text.   
    2) Вывести текущий ввод отзыва на экран. Отображать параграф text только если ввод начат.    
    3) Создать контроллер product, который будет пулучать предоставленные отзывы.     
    4) Сейчас свойство text привязано к свойству на моделе, но, на самом деле, мы хотим его на контроллере. Сделать, чтобы по умолчанию свойство text было пустой строкой.   

_Решение._
Создадим поле ввода, для которого в контроллере укажем, что по умолчанию оно должно содержать пустой текст. Сделаем так, чтобы при вводе над полем отображалось вводимое:    
app.js:
```javascript
App.ProductController = Ember.ObjectController.extend({
    text: ''
});
```
index.html:
```html
<script type='text/x-handlebars' data-template-name='product'>
    <div class='row'>
        <div class='col-sm-7'>
            ...
            <div class='new-review'>
                <h3>Review {{title}}</h3>

                <p class='text-muted'>{{text}}</p>
                {{textarea valueBinding='text'}}
            </div>
        </div>
        ...
    </div>
    ...
</script>
```

_Пояснение._
Очень часто в приложениях нужно делать возможность ввода чего-либо пользователем. Для таких случаев существует помощник {{textarea}}. Он создаёт поле ввода. Чтобы связать введёное значение с уже существующими свойствами, помещаем в помощник valueBinding. Его связь обрабатывается контроллером.   

## 7.3 Создание отзыва

_Задание._
Мы можем просматривать отзывы, но у нас пока нет возможности создавать их.    
    1) В шаблоне product создать кнопку, которая будет запускать действие createReview в текущем контроллере.   
    2) Создать функцию в контроллере, которая будет загружаться при клике по кнопке Review.   
    3) Построить новый объект Review внутри функции createReview. Убедиться, что он снабжается текстом, продуктом и значениями reviewedAt.   
    4) Сохранить объект review, который мы только что собрали для нашей сокальной фиксации.    
    5) После сохранения review сбросить текстовое значение в контроллере и вернуть пустую текстовую строку.   
    6) После сохранения review, добавить отзыв в массив отзывов в моделе product. Это обновит интерфейс с нашим новым отзывом.   

_Решение._
В HTML добавим под полем ввода кнопку, при клике на которую создаётся событие createReview. Все остальные манипуляции осуществим в app.js, а именно: создание в контроллере объекта actions, в котором сделаем так, чтобы при клике по кнопке поле пустело, а введёный текст добавлялся в массив отзывов:   
app.js:
```javascript
App.ProductController = Ember.ObjectController.extend({
    text: '',
    actions: {
        createReview: function () {
            var review = this.store.createRecord('review', {
                text: this.get('text'),
                product: this.get('model'),
                reviewedAt: new Date()
            });
            var controller = this;

            review.save().then(function (review) {
                controller.set('text', '');
                controller.get('model.reviews').addObject(review);
            });
        }
    }
});
```
index.html:
```html
<div class='new-review'>
    <h3>Review {{title}}</h3>
    {{#if text}}
    <p class='text-muted'>{{text}}</p>
    {{/if}}
    {{textarea valueBinding='text'}}
    <button
    {{action 'createReview'}} class='btn-primary'>Review</button>
</div>
```

_Пояснение._
Для добавления введёного в поле текста на страницу нужно реализовать 2 шага: добавить кнопку и написать код для добавления. Второй шаг включает в себя ещё 4: создание реагируещего события, построение нового объекта на базе введёной инфирмации, сохранение его на локальной фиксакции, отчистка поля ввода. 

## 7.4 Рейтинг продукта

_Задание._
В модель product, кто-то из членов нашей команды добавил свойство ratings, которое содержит массив от 1 до 5 и свойство rating, которое выводит среднее арифметическое. Они также добавили немного fixtures и отобразили рейтинг на странице product. Но, к сожалению, ещё не было добавлено способа оценить продукцию.   
    1) Мы будем использовать выбор елемента по рейтингу. Ember должен знать какие данные нужно использовать для выбора, спрашивая у контроллера. Добавить свойство для вызова ProductController, рейтингами которого являются числа от 1 до     5) Мы будем использовать их в качестве опций в выборе.   
    2) Как свойство text для review, мы будем связывать выбранное значение со свойством в контроллере. Создать это свойство и назвать его selectedRating, установив начальное значение  5)   
    3) Внутри шаблона product мы можем использовать Ember View, который представляет выбор элемента как в textarea. Мы будем использовать помощник {{view Ember.Select}}. Также передадим значение атрибута, которое соответствует созданному по умолчанию в контроллере и содержимое атрибута установим для нашего массива ratings.    
    4) Нам нужна кнопка, которая будет загружать action в контроллере при клике. Используя action, загрузить функцию createRating function в контроллер.    
    5) Создать функцию createRating в ProductController, которая будет загружаться при клике.    
    6) Rating не является объектом, как Review, поэтому функция createRating будет немного другой. Мы можем addObject выбранный рейтинг для массива рейтингов в product. Сохранить продукт для обновления в хранилище.   

_Решение._
Создадим возможность оценить товар путём добавления кнопки и выпадающего списка (для которого определим массив ratings от 1 до 5), установленного по умолчанию на 5, а также реализуем возможность добавлять свою оценку в массив:   
app.js:
```javascript
App.ProductController = Ember.ObjectController.extend({
    text: '',
    actions: {
        createReview: function () {
            var review = this.store.createRecord('review', {
                text: this.get('text'),
                product: this.get('model'),
                reviewedAt: new Date()
            });
            var controller = this;
            review.save().then(function () {
                controller.set('text', '');
                controller.get('model.reviews').addObject(review);
            });
        },
        createRating: function () {
            var prod = this.get('model');
            var ratings = this.get('model.ratings');
            ratings.addObject(this.selectedRating);
            prod.save();
        }
    },
    ratings: [1, 2, 3, 4, 5],
    selectedRating: 5
});
```
index.html:
```html
<div class='new-rating'>
    <h3>Rate {{title}}</h3>
    {{view Ember.Select content=ratings value=selectedRating}}
    <button {{action 'createRating'}} class='btn-primary'>Rating</button>
</div>
```

_Пояснение._
См. 7.2, 7.3.